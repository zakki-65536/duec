<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DUEC - 履修登録支援対話システム</title>
    <link rel="stylesheet" href="assets/css/reset.css" />

    <!-- PyScript -->
    <!-- <link rel="stylesheet" href="https://pyscript.net/releases/2024.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.11.1/core.js"></script> -->

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      }

      header {
        margin-left: 0.5cm;
        margin-right: 0.5cm;
        background-color: #3f1a55;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        height: 80px;
      }

      header img {
        height: 100px;
        margin-right: 20px;
      }

      main {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
        margin-left: 0.5cm;
        margin-right: 0.5cm;
        padding: 20px;
        background-color: #f0e6f2;
        position: relative;
      }

      #output {
        flex-grow: 1;
        overflow-y: auto;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 12px;
      }

      .message-row {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        max-width: 100%;
      }

      /* ユーザー行は右寄せ */
      .message-row.user-row {
        align-self: flex-end;
        flex-direction: row-reverse;
      }

      /* システム行は左寄せ*/
      .message-row.system-row {
        align-self: flex-start;
        flex-direction: row;
      }

      /* 左側に配置する画像 */
      .avatar-left {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: cover;
        flex: 0 0 48px; /* 固定幅 */
        align-self: flex-start; /* 上寄せして左上に配置する */
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        background: #fff;
      }

      /* メッセージバブル共通 */
      .message {
        max-width: 75%;
        padding: 12px 14px;
        border-radius: 14px;
        line-height: 1.4;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        word-break: break-word;
        white-space: pre-wrap;
      }

      /* システム（左寄せ） */
      .message.system {
        background-color: #ffffff;
        color: #111;
        border-top-left-radius: 4px;
        border-top-right-radius: 14px;
        border-bottom-right-radius: 14px;
        border-bottom-left-radius: 14px;
      }

      /* ユーザー（右寄せ） */
      .message.user {
        background: linear-gradient(135deg, #6a1b9a, #8e2fbf);
        color: #fff;
        border-top-right-radius: 4px;
        border-top-left-radius: 14px;
        border-bottom-left-radius: 14px;
        border-bottom-right-radius: 14px;
      }

      /* 入力フォーム */
      form {
        display: flex;
        align-items: flex-end;
        padding: 10px 0;
        max-width: 960px;
        margin: 0 auto;
        width: 100%;
        position: sticky;
        bottom: 0;
        background: transparent;
        gap: 10px;
      }

      .input {
        flex-grow: 1;
        display: flex;
        gap: 8px;
      }

      form input[type="text"] {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        background: white;
      }

      form input[type="button"] {
        padding: 10px 20px;
        border: none;
        background-color: #6a1b9a;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }

      .character {
        width: 120px;
        height: auto;
        margin-bottom: -5px;
        transform: translateX(10px);
      }

      /* スクロールバー */
      #output::-webkit-scrollbar {
        width: 10px;
      }
      #output::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.12);
        border-radius: 10px;
      }

      @media (max-width: 480px) {
        .avatar-left { width: 40px; height: 40px; flex: 0 0 40px; }
        .message { max-width: 82%; padding: 10px; }
      }

      /* ローディング表示 */
      .loading {
        position: absolute;
        right: 24px;
        bottom: 84px;
        display: none;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: rgba(255,255,255,0.96);
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        font-size: 14px;
        color: #222;
        z-index: 30;
      }

      .loading .spinner {
        width: 16px;
        height: 16px;
        border: 3px solid #e6e6e6;
        border-top-color: #6a1b9a;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin { to { transform: rotate(360deg); } }

    </style>
  </head>
  <body>
    <header>
      <img src="assets/img/duec-logo.png" alt="DUEC Logo">
    </header>

    <main>
      <div id="output" aria-live="polite"></div>
      <div id="loading" class="loading" role="status" aria-live="polite" aria-hidden="true">
        <div class="spinner" aria-hidden="true"></div>
        <div>応答を生成中…</div>
      </div>
      <form onsubmit="return false;">
        <img src="assets/img/usagi.png" alt="うさぎ" class="character">
        <div class="input">
          <input type="text" name="message" placeholder="DUECに質問してみよう" autocomplete="off" />
          <input type="button" value="送信" id="runBtn" />
        </div>
      </form>
    </main>

    <footer></footer>

    <script>
        // ====== PyScript の allMessages をそのままJSへ ======
        const allMessages = [];

        // ローディング表示の制御
        function showLoading(state) {
          const loadingEl = document.getElementById("loading");
          const btn = document.getElementById("runBtn");
          if (loadingEl) {
            loadingEl.style.display = state ? "flex" : "none";
            loadingEl.setAttribute('aria-hidden', state ? 'false' : 'true');
          }
          if (btn) {
            btn.disabled = !!state;
            if (state) btn.classList.add('disabled'); else btn.classList.remove('disabled');
          }
        }

        function render() {
          const out = document.getElementById("output");
          out.innerHTML = "";

          for (const [role, text] of allMessages) {
            const row = document.createElement("div");
            row.className = "message-row " + (role === "user" ? "user-row" : "system-row");

            if (role === "system") {
              const img = document.createElement("img");
              img.className = "avatar-left";
              img.src = "assets/img/usagi_system.png";
              row.appendChild(img);

              const bubble = document.createElement("div");
              bubble.className = "message system";
              bubble.innerText = text;
              row.appendChild(bubble);
            } else {
              const bubble = document.createElement("div");
              bubble.className = "message user";
              bubble.innerText = text;
              row.appendChild(bubble);
            }

            out.appendChild(row);
          }

          out.scrollTop = out.scrollHeight;
        }

        // UIの履歴(role: user/system) -> API用(user/assistant) に変換
        function toApiHistory(history) {
          return history.map(([role, text]) => {
            const apiRole = (role === "system") ? "assistant" : role;
            return [apiRole, text];
          });
        }

        // GETリクエスト: /chat?history=...&new_input=...
        // Note: backend runs on port 5001 to avoid macOS services on 5000
        async function doGet(history, newMessage, baseUrl = "http://127.0.0.1:5001/chat") {
          const apiHistory = toApiHistory(history);

          // 例URLと同様に、history は JSON文字列で渡す
          // encodeURIComponent で安全にURLエンコード
          const historyParam = encodeURIComponent(JSON.stringify(apiHistory));
          const newInputParam = encodeURIComponent(newMessage);

          const url = `${baseUrl}?history=${historyParam}&new_input=${newInputParam}`;

          const resp = await fetch(url, { method: "GET" });
          if (!resp.ok) {
            const body = await resp.text().catch(() => "");
            throw new Error(`HTTP ${resp.status} ${resp.statusText} ${body}`.trim());
          }
          // このAPIはテキストを返す想定
          return await resp.text();
        }

        // ====== PyScript の run() をそのままJSへ（async化） ======
        let isComposing = false; // IME 等の確定中フラグ
        let clearAfterComposition = false; // 送信後に compositionend で入力が再挿入されるのを防ぐ

        async function run(evt = null) {
          if (isComposing) return; // IME確定中は送信しない

          const form = document.forms[0];
          const inputEl = form.message;
          const message = inputEl.value.trim();
          if (!message) return;

          // 例URLと同様に、今回入力は history には入れず new_input に渡す
          const historyForApi = allMessages.slice();

          // 送信前に入力をクリアしておく（IME確定後に再挿入される場合があるため、
          // compositionend で再挿入されたら再度クリアするフラグを立てる）
          inputEl.value = "";
          clearAfterComposition = true;

          allMessages.push(["user", message]);
          render();

            // ローディング表示をON
            showLoading(true);

            let result;
            try {
              // APIが返すテキストを result に格納
              result = await doGet(historyForApi, message);
            } catch (e) {
              result = "システムエラー: " + (e && e.message ? e.message : String(e));
            } finally {
              // 必ずローディングをOFF
              showLoading(false);
            }

            allMessages.push(["system", result]);
            render();

          // 送信後は入力にフォーカスを戻す
          inputEl.focus();
        }

        // ====== イベント設定（PyScriptの addEventListener 相当） ======
        document.addEventListener("DOMContentLoaded", () => {
          // 初期のシステムメッセージを表示して会話を開始しているように見せる
          allMessages.push(["system", "こんにちは。私はDUECの履修相談システムです。どのような授業を探していますか？科目名・分野・学年・希望の特徴などを教えてください。"]);
          render();

          const btn = document.getElementById("runBtn");
          btn.addEventListener("click", run);

          const inputEl = document.forms[0].message;

          // composition イベントで IME の確定状態を追跡
          inputEl.addEventListener('compositionstart', () => {
            isComposing = true;
            clearAfterComposition = false;
          });
          inputEl.addEventListener('compositionend', () => {
            isComposing = false;
            if (clearAfterComposition) {
              inputEl.value = '';
              clearAfterComposition = false;
            }
          });

          inputEl.addEventListener("keydown", (evt) => {
            if (evt.key === "Enter") {
              // ブラウザによっては evt.isComposing が true のことがある
              if (evt.isComposing || isComposing) {
                return;
              }
              evt.preventDefault();
              run();
            }
          });
        });

    </script>

    

  </body>
</html>